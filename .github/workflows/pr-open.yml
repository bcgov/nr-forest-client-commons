name: Pull Request Open

on:
  pull_request:

concurrency:
  # PR open and close use the same group, allowing only one at a time
  group: pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vars:
    name: Variables
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.semver.outputs.tag }}
    steps:
      # steps.semver.outputs.tag => needs.vars.outputs.semver
      - uses: actions/checkout@v4
        with:
          ref: refs/heads/${{ github.event.repository.default_branch }}
      - name: Conventional Changelog Update
        uses: TriPSs/conventional-changelog-action@v5.3.0
        id: semver
        with:
          git-branch: refs/heads/${{ github.head_ref }}
          git-push: 'false'
          skip-commit: 'true'
          skip-on-empty: 'false'
          skip-version-file: 'true'

      - run: |
          echo "semver=${{ steps.semver.outputs.tag }}"

  pr-validation:
    name: Pull Request Validation
    runs-on: ubuntu-22.04
    needs: [vars]
    permissions:
      contents: read
      pull-requests: write    
    steps:
      - uses: actions/checkout@v4
      
      - name: Removing old core
        uses: paulushcgcj/delete-github-package@1.0.0
        continue-on-error: true
        with:
          token: ${{ secrets.PAT }}
          type: maven
          name: ca.bc.gov.nrs-commons.forest-client-core
          version: ${{ needs.vars.outputs.semver }}.PR${{ github.event.number }}
          user: ${{ github.repository_owner }}

      - name: Removing old spring
        uses: paulushcgcj/delete-github-package@1.0.0
        continue-on-error: true
        with:
          token: ${{ secrets.PAT }}
          type: maven
          name: ca.bc.gov.nrs-commons.forest-client-spring
          version: ${{ needs.vars.outputs.semver }}.PR${{ github.event.number }}
          user: ${{ github.repository_owner }}

  build-certextractor:
    name: Builds Cert Extractor
    runs-on: ubuntu-22.04
    needs: [pr-validation]
    steps:
      - uses: actions/checkout@v4

      - uses: bcgov-nr/action-builder-ghcr@v2.0.2
        name: Build Cert Extractor
        with:
          package: certextractor
          tag: ${{ github.event.number }}
          tag_fallback: test
          token: ${{ secrets.GITHUB_TOKEN }}
          triggers: "certextractor/"

  build-core:
    name: Build Core
    runs-on: ubuntu-22.04
    needs: [vars, pr-validation]
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: bcgov-nr/action-test-and-analyse-java@v1.0.2
        name: Core Coverage
        with:
          commands: |
            mvn -B verify -P all-tests checkstyle:checkstyle -Dcheckstyle.skip=false --file pom.xml
          dir: core
          java-cache: maven
          java-distribution: temurin
          java-version: "17"
          sonar_args: >
            -Dsonar.organization=bcgov-sonarcloud
            -Dsonar.projectKey=bcgov_nr-forest-client-commons
            sonar_token: ${{ secrets.SONAR_TOKEN_COMMONS }}

      - name: Publish Core
        uses: paulushcgcj/action-java-publish@v0.1.1
        with:
          dir: core
          app-version: ${{ needs.vars.outputs.semver }}.PR${{ github.event.number }}
          extra-params: -DskipTests -Dtests.skip=true
          add-sources: true
          add-javadoc: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
